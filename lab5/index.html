

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Lab 5: PID Control &mdash; ECE 5160: Fast Robots  documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css?v=13237357" />
      <link rel="stylesheet" type="text/css" href="../_static/sphinx-design.min.css?v=95c83b7e" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme_overrides.css?v=2e4e1787" />

  
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
      <script src="../_static/jquery.js?v=5d32c60e"></script>
      <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../_static/documentation_options.js?v=187304be"></script>
      <script src="../_static/doctools.js?v=9bcbadda"></script>
      <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script>let toggleHintShow = 'Click to show';</script>
      <script>let toggleHintHide = 'Click to hide';</script>
      <script>let toggleOpenOnPrint = 'true';</script>
      <script src="../_static/togglebutton.js?v=4a39c7ea"></script>
      <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
      <script src="../_static/design-tabs.js?v=f930bc37"></script>
      <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex/" />
    <link rel="search" title="Search" href="../search/" />
    <link rel="next" title="Lab 6: Orientation Control" href="../lab6/" />
    <link rel="prev" title="Lab 4: Open-Loop Motor Control" href="../lab4/" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../" class="icon icon-home">
            ECE 5160: Fast Robots
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search/" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Lab Write-Ups:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../lab1/">Lab 1: The Artemis Board and Bluetooth</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lab2/">Lab 2: IMU Pose Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lab3/">Lab 3: Time-of-Flight Sensing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lab4/">Lab 4: Open-Loop Motor Control</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Lab 5: PID Control</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#prelab">Prelab</a></li>
<li class="toctree-l2"><a class="reference internal" href="#designing-the-pid-controller">Designing the PID Controller</a></li>
<li class="toctree-l2"><a class="reference internal" href="#range-sampling-time">Range/Sampling Time</a></li>
<li class="toctree-l2"><a class="reference internal" href="#final-system">Final System</a></li>
<li class="toctree-l2"><a class="reference internal" href="#ece-5160-integrator-windup">[ECE 5160] Integrator Windup</a></li>
<li class="toctree-l2"><a class="reference internal" href="#acknowledgements">Acknowledgements</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../lab6/">Lab 6: Orientation Control</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lab7/">Lab 7: Kalman Filtering</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lab8/">Lab 8: Stunts!</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lab9/">Lab 9: Mapping</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lab10/">Lab 10: Localization (Simulation)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lab11/">Lab 11: Localization (Real)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lab12/">Lab 12: Path Planning and Execution</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../">ECE 5160: Fast Robots</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Lab 5: PID Control</li>
      <li class="wy-breadcrumbs-aside">
              <a href="https://github.com/Aidan-McNay/fast-robots-docs/blob/main/docs/lab5.rst" class="fa fa-github"> Edit on GitHub</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="lab-5-pid-control">
<h1>Lab 5: PID Control<a class="headerlink" href="#lab-5-pid-control" title="Link to this heading"></a></h1>
<p>Now that we’ve assembled our robot, we can introduce a PID control
system to help it navigate. In this lab, we use PID control to navigate
the robot 1 foot away from a wall.</p>
<section id="prelab">
<h2>Prelab<a class="headerlink" href="#prelab" title="Link to this heading"></a></h2>
<p>In this lab, it was especially important to communicate data over
Bluetooth, as it was the only way to gain visibility into the values
used in the algorithm, and adjust PID gains appropriately. To do this,
I defined a function <code class="docutils literal notranslate"><span class="pre">log_pid_data</span></code> on the Arduino, which our PID
loop could call; it would log various pieces of data, including:</p>
<ul class="simple">
<li><p>The current time</p></li>
<li><p>Whether ToF data was ready</p></li>
<li><p>The measured distance</p></li>
<li><p>The terms generated from PID control (including the integrator terms
with and without windup protection - useful for the M.Eng. portion)</p></li>
<li><p>The total PID control output</p></li>
<li><p>The PWM sent to the motors</p></li>
</ul>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="nf">log_pid_data</span><span class="p">(</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">time</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">data_ready</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">distance</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">kp_term</span><span class="p">,</span>
<span class="w">                   </span><span class="kt">int</span><span class="w"> </span><span class="n">ki_term</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">windup_term</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">kd_term</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">total_term</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">motor_pwm</span><span class="w"> </span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">entry_idx</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">MAX_NUM_ENTRIES</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">time_entries</span><span class="p">[</span><span class="n">entry_idx</span><span class="p">]</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="n">time</span><span class="p">;</span>
<span class="w">    </span><span class="n">data_ready_entries</span><span class="p">[</span><span class="n">entry_idx</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">data_ready</span><span class="p">;</span>
<span class="w">    </span><span class="n">distance_entries</span><span class="p">[</span><span class="n">entry_idx</span><span class="p">]</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">distance</span><span class="p">;</span>
<span class="w">    </span><span class="n">kp_term_entries</span><span class="p">[</span><span class="n">entry_idx</span><span class="p">]</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="n">kp_term</span><span class="p">;</span>
<span class="w">    </span><span class="n">ki_term_entries</span><span class="p">[</span><span class="n">entry_idx</span><span class="p">]</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="n">ki_term</span><span class="p">;</span>
<span class="w">    </span><span class="n">windup_term_entries</span><span class="p">[</span><span class="n">entry_idx</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">windup_term</span><span class="p">;</span>
<span class="w">    </span><span class="n">kd_term_entries</span><span class="p">[</span><span class="n">entry_idx</span><span class="p">]</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="n">kd_term</span><span class="p">;</span>
<span class="w">    </span><span class="n">total_term_entries</span><span class="p">[</span><span class="n">entry_idx</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">total_term</span><span class="p">;</span>
<span class="w">    </span><span class="n">motor_pwm_entries</span><span class="p">[</span><span class="n">entry_idx</span><span class="p">]</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">motor_pwm</span><span class="p">;</span>
<span class="w">    </span><span class="n">entry_idx</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>From here, I defined a BLE command <code class="docutils literal notranslate"><span class="pre">GET_PID_DATA</span></code> to retrieve all of
the recorded data</p>
<div class="toggle highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="c1">// Case statement from within handle_command()</span>

<span class="k">case</span><span class="w"> </span><span class="no">GET_PID_DATA</span><span class="p">:</span>
<span class="w">   </span><span class="n">Serial</span><span class="p">.</span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Getting data...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="w">   </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">entry_idx</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">     </span><span class="n">tx_estring_value</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
<span class="w">     </span><span class="n">tx_estring_value</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="w"> </span><span class="n">time_entries</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="p">);</span>
<span class="w">     </span><span class="n">tx_estring_value</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="w"> </span><span class="s">&quot;|&quot;</span><span class="w"> </span><span class="p">);</span>
<span class="w">     </span><span class="n">tx_estring_value</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="w"> </span><span class="n">data_ready_entries</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="p">);</span>
<span class="w">     </span><span class="n">tx_estring_value</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="w"> </span><span class="s">&quot;|&quot;</span><span class="w"> </span><span class="p">);</span>
<span class="w">     </span><span class="n">tx_estring_value</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="w"> </span><span class="n">distance_entries</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="p">);</span>
<span class="w">     </span><span class="n">tx_estring_value</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="w"> </span><span class="s">&quot;|&quot;</span><span class="w"> </span><span class="p">);</span>
<span class="w">     </span><span class="n">tx_estring_value</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="w"> </span><span class="n">kp_term_entries</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="p">);</span>
<span class="w">     </span><span class="n">tx_estring_value</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="w"> </span><span class="s">&quot;|&quot;</span><span class="w"> </span><span class="p">);</span>
<span class="w">     </span><span class="n">tx_estring_value</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="w"> </span><span class="n">ki_term_entries</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="p">);</span>
<span class="w">     </span><span class="n">tx_estring_value</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="w"> </span><span class="s">&quot;|&quot;</span><span class="w"> </span><span class="p">);</span>
<span class="w">     </span><span class="n">tx_estring_value</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="w"> </span><span class="n">windup_term_entries</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="p">);</span>
<span class="w">     </span><span class="n">tx_estring_value</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="w"> </span><span class="s">&quot;|&quot;</span><span class="w"> </span><span class="p">);</span>
<span class="w">     </span><span class="n">tx_estring_value</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="w"> </span><span class="n">kd_term_entries</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="p">);</span>
<span class="w">     </span><span class="n">tx_estring_value</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="w"> </span><span class="s">&quot;|&quot;</span><span class="w"> </span><span class="p">);</span>
<span class="w">     </span><span class="n">tx_estring_value</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="w"> </span><span class="n">total_term_entries</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="p">);</span>
<span class="w">     </span><span class="n">tx_estring_value</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="w"> </span><span class="s">&quot;|&quot;</span><span class="w"> </span><span class="p">);</span>
<span class="w">     </span><span class="n">tx_estring_value</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="w"> </span><span class="n">motor_pwm_entries</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="p">);</span>
<span class="w">     </span><span class="n">tx_characteristic_string</span><span class="p">.</span><span class="n">writeValue</span><span class="p">(</span><span class="w"> </span><span class="n">tx_estring_value</span><span class="p">.</span><span class="n">c_str</span><span class="p">()</span><span class="w"> </span><span class="p">);</span>
<span class="w">   </span><span class="p">}</span>
<span class="w">   </span><span class="k">break</span><span class="p">;</span>
</pre></div>
</div>
<p>All that was needed to receive the data was a custom handler to
receive BLE notifications in Python:</p>
<div class="toggle highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">parse_data</span><span class="p">(</span> <span class="n">data</span><span class="p">:</span> <span class="nb">str</span> <span class="p">):</span>
  <span class="n">data_components</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;|&quot;</span><span class="p">)</span>
  <span class="n">time</span>       <span class="o">=</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">data_components</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">)</span>
  <span class="n">ready</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">data_components</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
  <span class="n">distance</span>   <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">data_components</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
  <span class="n">kp_term</span>    <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">data_components</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
  <span class="n">ki_term</span>    <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">data_components</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
  <span class="n">windup_term</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">data_components</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span>
  <span class="n">kd_term</span>    <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">data_components</span><span class="p">[</span><span class="mi">6</span><span class="p">])</span>
  <span class="n">total_term</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">data_components</span><span class="p">[</span><span class="mi">7</span><span class="p">])</span>
  <span class="n">motor_pwm</span>  <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">data_components</span><span class="p">[</span><span class="mi">8</span><span class="p">])</span>
  <span class="k">return</span> <span class="n">time</span><span class="p">,</span> <span class="n">ready</span><span class="p">,</span> <span class="n">distance</span><span class="p">,</span> <span class="n">kp_term</span><span class="p">,</span> <span class="n">ki_term</span><span class="p">,</span> <span class="n">windup_term</span><span class="p">,</span> <span class="n">kd_term</span><span class="p">,</span> <span class="n">total_term</span><span class="p">,</span> <span class="n">motor_pwm</span>

<span class="k">def</span><span class="w"> </span><span class="nf">data_handler</span><span class="p">(</span><span class="n">_uid</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>
  <span class="k">global</span> <span class="n">i</span>
  <span class="n">time</span><span class="p">,</span> <span class="n">ready</span><span class="p">,</span> <span class="n">distance</span><span class="p">,</span> <span class="n">kp_term</span><span class="p">,</span> <span class="n">ki_term</span><span class="p">,</span> <span class="n">windup_term</span><span class="p">,</span> <span class="n">kd_term</span><span class="p">,</span> <span class="n">total_term</span><span class="p">,</span> <span class="n">motor_pwm</span> <span class="o">=</span> <span class="n">parse_data</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span>
  <span class="n">data_time</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">time</span><span class="p">)</span>
  <span class="n">data_ready</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ready</span><span class="p">)</span>
  <span class="n">data_distance</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">distance</span><span class="p">)</span>
  <span class="n">data_kp_term</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">kp_term</span><span class="p">)</span>
  <span class="n">data_ki_term</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ki_term</span><span class="p">)</span>
  <span class="n">data_windup_term</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">windup_term</span><span class="p">)</span>
  <span class="n">data_kd_term</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">kd_term</span><span class="p">)</span>
  <span class="n">data_total_term</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">total_term</span><span class="p">)</span>
  <span class="n">data_motor_pwm</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">motor_pwm</span><span class="p">)</span>
  <span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>
  <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">i</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">100</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">NUM_SAMPLES</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">% done&quot;</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\r</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="n">ble</span><span class="o">.</span><span class="n">start_notify</span><span class="p">(</span><span class="n">ble</span><span class="o">.</span><span class="n">uuid</span><span class="p">[</span><span class="s1">&#39;RX_STRING&#39;</span><span class="p">],</span> <span class="n">data_handler</span><span class="p">)</span>
<span class="n">ble</span><span class="o">.</span><span class="n">send_command</span><span class="p">(</span><span class="n">CMD</span><span class="o">.</span><span class="n">GET_PID_DATA</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>After testing with some dummy data, I was successfully able to communicate
data and parse it, providing an invaluable tool for later debugging.</p>
<p>The other thing I did before beginning the lab was to revisit code from
past labs, and package them into object-oriented classes for easier
handling and re-use. As an example, here is the header file for my
<code class="docutils literal notranslate"><span class="pre">Car</span></code> implementation (which utilizes the <code class="docutils literal notranslate"><span class="pre">Wheel</span></code> class to drive
motors):</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Car</span><span class="w"> </span><span class="p">{</span>
<span class="w"> </span><span class="k">public</span><span class="o">:</span>
<span class="w">  </span><span class="n">Car</span><span class="p">(</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">MOTOR1_IN1_PIN</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">MOTOR1_IN2_PIN</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">MOTOR2_IN1_PIN</span><span class="p">,</span>
<span class="w">       </span><span class="kt">int</span><span class="w"> </span><span class="n">MOTOR2_IN2_PIN</span><span class="w"> </span><span class="p">)</span>
<span class="w">      </span><span class="o">:</span><span class="w"> </span><span class="n">motor1</span><span class="p">(</span><span class="w"> </span><span class="n">MOTOR1_IN1_PIN</span><span class="p">,</span><span class="w"> </span><span class="n">MOTOR1_IN2_PIN</span><span class="w"> </span><span class="p">),</span>
<span class="w">        </span><span class="n">motor2</span><span class="p">(</span><span class="w"> </span><span class="n">MOTOR2_IN1_PIN</span><span class="p">,</span><span class="w"> </span><span class="n">MOTOR2_IN2_PIN</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{};</span>

<span class="w">  </span><span class="c1">// Calibration from Lab 4</span>
<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="nf">set_motor2_calibration</span><span class="p">(</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">factor</span><span class="w"> </span><span class="p">)</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="n">motor2</span><span class="p">.</span><span class="n">set_calibration_factor</span><span class="p">(</span><span class="w"> </span><span class="n">factor</span><span class="w"> </span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="c1">// Motor functions from Lab 4</span>
<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">pwm</span><span class="w"> </span><span class="p">);</span>
<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="nf">backward</span><span class="p">(</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">pwm</span><span class="w"> </span><span class="p">);</span>
<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="nf">left</span><span class="p">(</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">pwm</span><span class="w"> </span><span class="p">);</span>
<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="nf">right</span><span class="p">(</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">pwm</span><span class="w"> </span><span class="p">);</span>
<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="nf">stop</span><span class="p">();</span>
<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="nf">coast</span><span class="p">();</span>

<span class="w"> </span><span class="k">private</span><span class="o">:</span>
<span class="w">  </span><span class="n">Wheel</span><span class="w"> </span><span class="n">motor1</span><span class="p">,</span><span class="w"> </span><span class="n">motor2</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>
</div>
<p>This makes our code more portable and abstracts the details from
the PID interface.</p>
</section>
<section id="designing-the-pid-controller">
<h2>Designing the PID Controller<a class="headerlink" href="#designing-the-pid-controller" title="Link to this heading"></a></h2>
<p>In this lab, we built up to a PID control system, which uses proportional,
integral, and derivative error terms to determine how much to drive the
motors to get 1 foot from a wall, determining motor PWM from error terms:</p>
<div class="math notranslate nohighlight">
\[u(t) = K_Pe(t) + K_I \int_0^te(t)\delta t + K_D \frac{\delta e(t)}{\delta t}\]</div>
<p>I began with only using a proportional term:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="nf">PID::update</span><span class="p">(</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">u</span><span class="w"> </span><span class="p">)</span>
<span class="p">{</span>
<span class="w">   </span><span class="kt">int</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">u</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">set_point</span><span class="p">;</span>
<span class="w">   </span><span class="n">terms</span><span class="p">.</span><span class="n">kp_term</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">params</span><span class="p">.</span><span class="n">kp</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">PID::get_control</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">terms</span><span class="p">.</span><span class="n">kp_term</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>A <code class="docutils literal notranslate"><span class="pre">PID</span></code> object was updated in the main loop with new ToF values
when available (using the previous if not):</p>
<div class="toggle highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="nf">run_pid_step</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">  </span><span class="n">curr_time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">millis</span><span class="p">();</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">curr_distance</span><span class="p">,</span><span class="w"> </span><span class="n">curr_kp_term</span><span class="p">,</span><span class="w"> </span><span class="n">curr_ki_term</span><span class="p">,</span><span class="w"> </span><span class="n">curr_ki_windup</span><span class="p">,</span>
<span class="w">      </span><span class="n">curr_kd_term</span><span class="p">,</span><span class="w"> </span><span class="n">curr_total_term</span><span class="p">,</span><span class="w"> </span><span class="n">curr_motor_pwm</span><span class="p">;</span>

<span class="w">  </span><span class="kt">bool</span><span class="w"> </span><span class="n">data_ready</span><span class="p">;</span>
<span class="w">  </span><span class="k">if</span><span class="p">(</span><span class="w"> </span><span class="n">tofs</span><span class="p">.</span><span class="n">sensor1</span><span class="p">.</span><span class="n">checkForDataReady</span><span class="p">()</span><span class="w"> </span><span class="p">){</span>
<span class="w">    </span><span class="n">curr_distance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tofs</span><span class="p">.</span><span class="n">sensor1</span><span class="p">.</span><span class="n">getDistance</span><span class="p">();</span>
<span class="w">    </span><span class="n">last_distance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">curr_distance</span><span class="p">;</span>
<span class="w">    </span><span class="n">tofs</span><span class="p">.</span><span class="n">sensor1</span><span class="p">.</span><span class="n">clearInterrupt</span><span class="p">();</span>
<span class="w">    </span><span class="n">tofs</span><span class="p">.</span><span class="n">sensor1</span><span class="p">.</span><span class="n">stopRanging</span><span class="p">();</span>
<span class="w">    </span><span class="n">tofs</span><span class="p">.</span><span class="n">sensor1</span><span class="p">.</span><span class="n">startRanging</span><span class="p">();</span>
<span class="w">    </span><span class="n">data_ready</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">curr_distance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">last_distance</span><span class="p">;</span>
<span class="w">    </span><span class="n">data_ready</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="n">pid</span><span class="p">.</span><span class="n">update</span><span class="p">(</span><span class="w"> </span><span class="n">curr_distance</span><span class="w"> </span><span class="p">);</span>
<span class="w">  </span><span class="n">curr_total_term</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">pid</span><span class="p">.</span><span class="n">get_control</span><span class="p">();</span>
<span class="w">  </span><span class="n">curr_kp_term</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="n">pid</span><span class="p">.</span><span class="n">terms</span><span class="p">.</span><span class="n">kp_term</span><span class="p">;</span>
<span class="w">  </span><span class="n">curr_ki_term</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="n">pid</span><span class="p">.</span><span class="n">terms</span><span class="p">.</span><span class="n">ki_term</span><span class="p">;</span>
<span class="w">  </span><span class="n">curr_ki_windup</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="n">pid</span><span class="p">.</span><span class="n">terms</span><span class="p">.</span><span class="n">ki_windup_term</span><span class="p">;</span>
<span class="w">  </span><span class="n">curr_kd_term</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="n">pid</span><span class="p">.</span><span class="n">terms</span><span class="p">.</span><span class="n">kd_term</span><span class="p">;</span>
<span class="w">  </span><span class="n">curr_motor_pwm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pid</span><span class="p">.</span><span class="n">scale</span><span class="p">(</span><span class="w"> </span><span class="n">curr_total_term</span><span class="w"> </span><span class="p">);</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">curr_motor_pwm</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">car</span><span class="p">.</span><span class="n">forward</span><span class="p">(</span><span class="w"> </span><span class="n">curr_motor_pwm</span><span class="w"> </span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">car</span><span class="p">.</span><span class="n">backward</span><span class="p">(</span><span class="w"> </span><span class="mi">-1</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">curr_motor_pwm</span><span class="w"> </span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="n">log_pid_data</span><span class="p">(</span><span class="w"> </span><span class="n">curr_time</span><span class="p">,</span><span class="w"> </span><span class="n">data_ready</span><span class="p">,</span><span class="w"> </span><span class="n">curr_distance</span><span class="p">,</span><span class="w"> </span><span class="n">curr_kp_term</span><span class="p">,</span>
<span class="w">                </span><span class="n">curr_ki_term</span><span class="p">,</span><span class="w"> </span><span class="n">curr_ki_windup</span><span class="p">,</span><span class="w"> </span><span class="n">curr_kd_term</span><span class="p">,</span><span class="w"> </span><span class="n">curr_total_term</span><span class="p">,</span><span class="w"> </span><span class="n">curr_motor_pwm</span><span class="w"> </span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">loop</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">  </span><span class="c1">// Main loop code...</span>
<span class="w">  </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">central</span><span class="p">.</span><span class="n">connected</span><span class="p">()</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">run_pid</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// Set by RUN_PID BLE Command</span>
<span class="w">      </span><span class="n">run_pid_step</span><span class="p">();</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">curr_time</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">pid_start_time</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">10000</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">stop_pid</span><span class="p">();</span><span class="w"> </span><span class="c1">// run_pid = false</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Note that after 10 seconds, or if Bluetooth disconnects, PID control
stops (as a failsafe).</p>
<p>Also note that I included a <code class="docutils literal notranslate"><span class="pre">pid.scale()</span></code> function; this imposed an upper
limit on the PWM value, moved it outside of the deadband, and also
helped account for the lesser drive strength I observed when reversing:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span><span class="w"> </span><span class="nf">PID::scale</span><span class="p">(</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">pid_output</span><span class="w"> </span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="kt">float</span><span class="w"> </span><span class="n">intermediate_term</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pid_output</span><span class="p">;</span>

<span class="w">  </span><span class="c1">// Scale outside deadband</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">intermediate_term</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">intermediate_term</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">deadband</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">intermediate_term</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="n">deadband</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">1.5</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="c1">// Reverse having issues, so scale</span>
<span class="w">  </span><span class="k">if</span><span class="p">(</span><span class="w"> </span><span class="n">intermediate_term</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">){</span>
<span class="w">    </span><span class="n">intermediate_term</span><span class="w"> </span><span class="o">*=</span><span class="w"> </span><span class="mf">1.5</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="c1">// Max PWM of 120</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">intermediate_term</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">120</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">intermediate_term</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">120</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">intermediate_term</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">-120</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">intermediate_term</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">-120</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">intermediate_term</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>From here, I was able to get a successful result using
<span class="math notranslate nohighlight">\(K_p = 0.05\)</span>, albeit with some overshooting.</p>
<a class="bottompadding reference internal image-reference" href="../_images/prop-0.05.png"><img alt="../_images/prop-0.05.png" class="bottompadding align-center" src="../_images/prop-0.05.png" style="width: 90%;" />
</a>
<p>(The robot initially turns from some slipping, not lack of calibration).</p>
<div class="video_wrapper align-center" style="padding-bottom: 39.375000%; padding-top: 30px; position: relative; text-align: center; width: 70%">
<iframe allowfullscreen="true" src="https://www.youtube.com/embed/HmI5krO30OU" style="border: 0; height: 100%; left: 0; position: absolute; top: 0; width: 100%">
</iframe></div><p>From here, I added an integral term:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="nf">PID::update</span><span class="p">(</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">u</span><span class="w"> </span><span class="p">)</span>
<span class="p">{</span>
<span class="w">   </span><span class="kt">int</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">u</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">set_point</span><span class="p">;</span>
<span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">first_time</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// Only run the first time, to set last_time</span>
<span class="w">     </span><span class="n">last_time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">micros</span><span class="p">();</span>
<span class="w">   </span><span class="p">}</span>

<span class="w">   </span><span class="c1">// ---------------------------------------------------------------------</span>
<span class="w">   </span><span class="c1">// Proportional</span>
<span class="w">   </span><span class="c1">// ---------------------------------------------------------------------</span>

<span class="w">   </span><span class="n">terms</span><span class="p">.</span><span class="n">kp_term</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">params</span><span class="p">.</span><span class="n">kp</span><span class="p">;</span>

<span class="w">   </span><span class="c1">// ---------------------------------------------------------------------</span>
<span class="w">   </span><span class="c1">// Integral</span>
<span class="w">   </span><span class="c1">// ---------------------------------------------------------------------</span>

<span class="w">   </span><span class="kt">int</span><span class="w"> </span><span class="n">curr_time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">micros</span><span class="p">();</span>
<span class="w">   </span><span class="kt">float</span><span class="w"> </span><span class="n">dt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">float</span><span class="p">)(</span><span class="n">curr_time</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">last_time</span><span class="p">);</span>
<span class="w">   </span><span class="n">last_time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">curr_time</span><span class="p">;</span>

<span class="w">   </span><span class="c1">// Perform in terms of seconds, like model</span>
<span class="w">   </span><span class="k">if</span><span class="p">(</span><span class="w"> </span><span class="o">!</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">clamp</span><span class="p">(</span><span class="n">error</span><span class="p">)</span><span class="w"> </span><span class="p">){</span>
<span class="w">     </span><span class="n">terms</span><span class="p">.</span><span class="n">ki_term</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">params</span><span class="p">.</span><span class="n">ki</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">((</span><span class="kt">float</span><span class="p">)</span><span class="w"> </span><span class="n">error</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">dt</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">1000000.0</span><span class="p">;</span>
<span class="w">   </span><span class="p">}</span>

<span class="w">   </span><span class="n">terms</span><span class="p">.</span><span class="n">ki_windup_term</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">params</span><span class="p">.</span><span class="n">ki</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">((</span><span class="kt">float</span><span class="p">)</span><span class="w"> </span><span class="n">error</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">dt</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">1000000.0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">PID::get_control</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">  </span><span class="c1">// PI Controller</span>
<span class="w">  </span><span class="n">curr_control</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">terms</span><span class="p">.</span><span class="n">kp_term</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">terms</span><span class="p">.</span><span class="n">ki_term</span><span class="p">;</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">curr_control</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Note the only integrate when <code class="docutils literal notranslate"><span class="pre">clamp()</span></code> is false; this is discussed more
in the M.Eng. section.</p>
<p>I found initial success with
<span class="math notranslate nohighlight">\(K_p = 0.04, K_I = 0.003\)</span>:</p>
<a class="bottompadding reference internal image-reference" href="../_images/prop-int.png"><img alt="../_images/prop-int.png" class="bottompadding align-center" src="../_images/prop-int.png" style="width: 90%;" />
</a>
<div class="video_wrapper align-center" style="padding-bottom: 39.375000%; padding-top: 30px; position: relative; text-align: center; width: 70%">
<iframe allowfullscreen="true" src="https://www.youtube.com/embed/TZz4-My06f4" style="border: 0; height: 100%; left: 0; position: absolute; top: 0; width: 100%">
</iframe></div><p>This resulted in a constant offset from the integrator; however, this was
resolved later by moving faster, clamping the integrator on the approach.
(I also had some calibration issues from motor depletion, fixed by charging
the battery).</p>
<p>Finally, I introduced a derivative term to slow the approach.
To avoid derivative kick, I low-passed it by factoring in the previous
value (finding experimentally that <span class="math notranslate nohighlight">\(\alpha = 0.25\)</span> works well),
and didn’t update the first time (when <span class="math notranslate nohighlight">\(\delta t\)</span> was near-zero):</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="nf">PID::update</span><span class="p">(</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">u</span><span class="w"> </span><span class="p">)</span>
<span class="p">{</span>
<span class="w">   </span><span class="kt">int</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">u</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">set_point</span><span class="p">;</span>
<span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">first_time</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">     </span><span class="n">last_time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">micros</span><span class="p">();</span>
<span class="w">     </span><span class="n">error_hist</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">error</span><span class="p">;</span>
<span class="w">   </span><span class="p">}</span>

<span class="w">   </span><span class="c1">// ---------------------------------------------------------------------</span>
<span class="w">   </span><span class="c1">// Proportional</span>
<span class="w">   </span><span class="c1">// ---------------------------------------------------------------------</span>

<span class="w">   </span><span class="n">terms</span><span class="p">.</span><span class="n">kp_term</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">params</span><span class="p">.</span><span class="n">kp</span><span class="p">;</span>

<span class="w">   </span><span class="c1">// ---------------------------------------------------------------------</span>
<span class="w">   </span><span class="c1">// Integral</span>
<span class="w">   </span><span class="c1">// ---------------------------------------------------------------------</span>

<span class="w">   </span><span class="kt">int</span><span class="w"> </span><span class="n">curr_time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">micros</span><span class="p">();</span>
<span class="w">   </span><span class="kt">float</span><span class="w"> </span><span class="n">dt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">float</span><span class="p">)(</span><span class="n">curr_time</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">last_time</span><span class="p">);</span>
<span class="w">   </span><span class="n">last_time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">curr_time</span><span class="p">;</span>

<span class="w">   </span><span class="c1">// Perform in terms of seconds, like model</span>
<span class="w">   </span><span class="k">if</span><span class="p">(</span><span class="w"> </span><span class="o">!</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">clamp</span><span class="p">(</span><span class="n">error</span><span class="p">)</span><span class="w"> </span><span class="p">){</span>
<span class="w">     </span><span class="n">terms</span><span class="p">.</span><span class="n">ki_term</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">params</span><span class="p">.</span><span class="n">ki</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">((</span><span class="kt">float</span><span class="p">)</span><span class="w"> </span><span class="n">error</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">dt</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">1000000.0</span><span class="p">;</span>
<span class="w">   </span><span class="p">}</span>

<span class="w">   </span><span class="n">terms</span><span class="p">.</span><span class="n">ki_windup_term</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">params</span><span class="p">.</span><span class="n">ki</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">((</span><span class="kt">float</span><span class="p">)</span><span class="w"> </span><span class="n">error</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">dt</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">1000000.0</span><span class="p">;</span>

<span class="w">   </span><span class="c1">// ---------------------------------------------------------------------</span>
<span class="w">   </span><span class="c1">// Derivative</span>
<span class="w">   </span><span class="c1">// ---------------------------------------------------------------------</span>

<span class="w">   </span><span class="k">if</span><span class="p">(</span><span class="w"> </span><span class="o">!</span><span class="n">first_time</span><span class="w"> </span><span class="p">){</span>
<span class="w">     </span><span class="kt">float</span><span class="w"> </span><span class="n">derivative</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">float</span><span class="p">)(</span><span class="n">error</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">error_hist</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">1000000.0</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">dt</span><span class="p">;</span>
<span class="w">     </span><span class="n">terms</span><span class="p">.</span><span class="n">kd_term</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">params</span><span class="p">.</span><span class="n">kd</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="kt">float</span><span class="p">)((</span><span class="kt">float</span><span class="p">)(</span><span class="n">alpha</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">derivative</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">((</span><span class="kt">float</span><span class="p">)(</span><span class="mi">1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">alpha</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">terms</span><span class="p">.</span><span class="n">kd_term</span><span class="p">));</span>
<span class="w">   </span><span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">PID::get_control</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">  </span><span class="c1">// PID Controller</span>
<span class="w">  </span><span class="n">curr_control</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">terms</span><span class="p">.</span><span class="n">kp_term</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">terms</span><span class="p">.</span><span class="n">ki_term</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">terms</span><span class="p">.</span><span class="n">kd_term</span><span class="p">;</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">curr_control</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>This final PID controller worked well with <span class="math notranslate nohighlight">\(K_P = 0.13, K_I = 0.008, K_D = 0.05\)</span></p>
<a class="bottompadding reference internal image-reference" href="../_images/prop-int-der-2m-nointerp.png"><img alt="../_images/prop-int-der-2m-nointerp.png" class="bottompadding align-center" src="../_images/prop-int-der-2m-nointerp.png" style="width: 90%;" />
</a>
<div class="video_wrapper align-center" style="padding-bottom: 39.375000%; padding-top: 30px; position: relative; text-align: center; width: 70%">
<iframe allowfullscreen="true" src="https://www.youtube.com/embed/nR-FGjlsmz8" style="border: 0; height: 100%; left: 0; position: absolute; top: 0; width: 100%">
</iframe></div></section>
<section id="range-sampling-time">
<h2>Range/Sampling Time<a class="headerlink" href="#range-sampling-time" title="Link to this heading"></a></h2>
<p>The PID controller is limited by how often we can get new data; to help, I
increased our data rate by changing the ranging time, sacrificing
speed for accuracy:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;SparkFun_VL53L1X.h&quot;</span>

<span class="c1">// In ToF sensor initialization</span>

<span class="n">sensor</span><span class="p">.</span><span class="n">setTimingBudgetInMs</span><span class="p">(</span><span class="w"> </span><span class="mi">33</span><span class="w"> </span><span class="p">);</span>
<span class="n">sensor</span><span class="p">.</span><span class="n">setIntermeasurementPeriod</span><span class="p">(</span><span class="w"> </span><span class="mi">40</span><span class="w"> </span><span class="p">);</span>
</pre></div>
</div>
<p>We can use the logger data in Python to determine loop and data rates:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">loop_frequency</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data_time</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">data_time</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">data_time</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loop Frequency: </span><span class="si">{</span><span class="n">loop_frequency</span><span class="si">:</span><span class="s2">&gt;7.2f</span><span class="si">}</span><span class="s2"> Hz&quot;</span><span class="p">)</span>

<span class="n">ready_data_times</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data_time</span><span class="p">)):</span>
  <span class="k">if</span><span class="p">(</span> <span class="n">data_ready</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">):</span>
    <span class="n">ready_data_times</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data_time</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

<span class="n">data_frequency</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ready_data_times</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">ready_data_times</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">ready_data_times</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Data Frequency: </span><span class="si">{</span><span class="n">data_frequency</span><span class="si">:</span><span class="s2">&gt;7.2f</span><span class="si">}</span><span class="s2"> Hz&quot;</span><span class="p">)</span>
</pre></div>
</div>
<a class="bottompadding reference internal image-reference" href="../_images/data-rate.png"><img alt="../_images/data-rate.png" class="bottompadding align-center" src="../_images/data-rate.png" style="width: 70%;" />
</a>
<p>I was getting a new value every ~4 iterations (28Hz approximately matching the
40ms sampling interval). To
improve upon this, I kept track of past distances to linearly extrapolate new
data points when distance isn’t available:</p>
<div class="literal-block-wrapper docutils container" id="id1">
<div class="code-block-caption"><span class="caption-text">Revised PID step</span><a class="headerlink" href="#id1" title="Link to this code"></a></div>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span><span class="w"> </span><span class="nf">interp_distance</span><span class="p">(){</span>
<span class="w">  </span><span class="c1">// Interpolate distance when none available</span>
<span class="w">  </span><span class="k">if</span><span class="p">(</span><span class="w"> </span><span class="n">last_last_distance_valid</span><span class="w"> </span><span class="p">){</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">slope</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((</span><span class="kt">float</span><span class="p">)(</span><span class="n">last_distance</span><span class="w">      </span><span class="o">-</span><span class="w"> </span><span class="n">last_last_distance</span><span class="p">))</span><span class="w"> </span><span class="o">/</span>
<span class="w">                  </span><span class="p">((</span><span class="kt">float</span><span class="p">)(</span><span class="n">last_distance_time</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">last_last_distance_time</span><span class="p">));</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">last_distance</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">slope</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">((</span><span class="kt">float</span><span class="p">)</span><span class="n">millis</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">last_distance_time</span><span class="p">));</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="c1">// Otherwise, return last data point</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">last_distance</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">run_pid_step</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">  </span><span class="n">curr_time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">millis</span><span class="p">();</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">curr_distance</span><span class="p">;</span>

<span class="w">  </span><span class="kt">bool</span><span class="w"> </span><span class="n">data_ready</span><span class="p">;</span><span class="w"> </span><span class="c1">// Use to log if data was ready</span>
<span class="w">  </span><span class="k">if</span><span class="p">(</span><span class="w"> </span><span class="n">tofs</span><span class="p">.</span><span class="n">sensor1</span><span class="p">.</span><span class="n">checkForDataReady</span><span class="p">()</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Shift values</span>
<span class="w">    </span><span class="n">last_last_distance</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="n">last_distance</span><span class="p">;</span>
<span class="w">    </span><span class="n">last_last_distance_valid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">last_distance_valid</span><span class="p">;</span>
<span class="w">    </span><span class="n">last_last_distance_time</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">last_distance_time</span><span class="p">;</span>

<span class="w">    </span><span class="n">curr_distance</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="n">tofs</span><span class="p">.</span><span class="n">sensor1</span><span class="p">.</span><span class="n">getDistance</span><span class="p">();</span>
<span class="w">    </span><span class="n">last_distance</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="n">curr_distance</span><span class="p">;</span>
<span class="w">    </span><span class="n">last_distance_time</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">curr_time</span><span class="p">;</span>
<span class="w">    </span><span class="n">last_distance_valid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="w">    </span><span class="n">data_ready</span><span class="w">          </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Start ranging again</span>
<span class="w">    </span><span class="n">tofs</span><span class="p">.</span><span class="n">sensor1</span><span class="p">.</span><span class="n">clearInterrupt</span><span class="p">();</span>
<span class="w">    </span><span class="n">tofs</span><span class="p">.</span><span class="n">sensor1</span><span class="p">.</span><span class="n">stopRanging</span><span class="p">();</span>
<span class="w">    </span><span class="n">tofs</span><span class="p">.</span><span class="n">sensor1</span><span class="p">.</span><span class="n">startRanging</span><span class="p">();</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">curr_distance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">interp_distance</span><span class="p">();</span>
<span class="w">    </span><span class="n">data_ready</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="c1">// Execute PID control like before...</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<p>Comparing to before, our better data helped to avoid oscillations:</p>
<a class="bottompadding reference internal image-reference" href="../_images/prop-int-der-2m-interp.png"><img alt="../_images/prop-int-der-2m-interp.png" class="bottompadding align-center" src="../_images/prop-int-der-2m-interp.png" style="width: 90%;" />
</a>
<a class="bottompadding reference internal image-reference" href="../_images/distance-data.png"><img alt="../_images/distance-data.png" class="bottompadding align-center" src="../_images/distance-data.png" style="width: 90%;" />
</a>
</section>
<section id="final-system">
<h2>Final System<a class="headerlink" href="#final-system" title="Link to this heading"></a></h2>
<p>We can demonstrate the system’s capabilities to settle quickly by running
from a long distance (around 3.5 meters).</p>
<a class="bottompadding reference internal image-reference" href="../_images/prop-int-der-3m5-demo.png"><img alt="../_images/prop-int-der-3m5-demo.png" class="bottompadding align-center" src="../_images/prop-int-der-3m5-demo.png" style="width: 90%;" />
</a>
<div class="video_wrapper align-center" style="padding-bottom: 39.375000%; padding-top: 30px; position: relative; text-align: center; width: 70%">
<iframe allowfullscreen="true" src="https://www.youtube.com/embed/Spz5SDtPjmA" style="border: 0; height: 100%; left: 0; position: absolute; top: 0; width: 100%">
</iframe></div><p>It also showed success when starting closer than the set point, around
half a foot:</p>
<a class="bottompadding reference internal image-reference" href="../_images/prop-int-der-1f-demo.png"><img alt="../_images/prop-int-der-1f-demo.png" class="bottompadding align-center" src="../_images/prop-int-der-1f-demo.png" style="width: 90%;" />
</a>
<div class="video_wrapper align-center" style="padding-bottom: 39.375000%; padding-top: 30px; position: relative; text-align: center; width: 70%">
<iframe allowfullscreen="true" src="https://www.youtube.com/embed/wBjYWQWCNJM" style="border: 0; height: 100%; left: 0; position: absolute; top: 0; width: 100%">
</iframe></div><p>Finally, the closed-loop control allows it to run successfully on
multiple surfaces, including the carpet in my apartment (having
less oscillation from more traction), about 3 meters:</p>
<a class="bottompadding reference internal image-reference" href="../_images/prop-int-der-3m-carpet.png"><img alt="../_images/prop-int-der-3m-carpet.png" class="bottompadding align-center" src="../_images/prop-int-der-3m-carpet.png" style="width: 90%;" />
</a>
<div class="video_wrapper align-center" style="padding-bottom: 39.375000%; padding-top: 30px; position: relative; text-align: center; width: 70%">
<iframe allowfullscreen="true" src="https://www.youtube.com/embed/aafRepBMdoo" style="border: 0; height: 100%; left: 0; position: absolute; top: 0; width: 100%">
</iframe></div></section>
<section id="ece-5160-integrator-windup">
<h2>[ECE 5160] Integrator Windup<a class="headerlink" href="#ece-5160-integrator-windup" title="Link to this heading"></a></h2>
<p>An important factor in our controller is protection against <em>windup</em>,
where the integrator excessively accumulates when not moving, such that
the overshoot caused by buildup is large. We protect against this by
only accumulating when we’re not “clamping”,:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="kt">bool</span><span class="w"> </span><span class="nf">PID::clamp</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// Clamp if we&#39;re at the maximum control and our error sign matches</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">((</span><span class="w"> </span><span class="n">curr_control</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">180</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">curr_control</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">-180</span><span class="w"> </span><span class="p">))</span><span class="w"> </span><span class="o">&amp;</span>
<span class="w">         </span><span class="p">(</span><span class="n">error</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">curr_control</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>To show this effect, I ran the same control loop while accumulating a
non-clamped term, and initially held the car in-place to accumulate error:</p>
<a class="bottompadding reference internal image-reference" href="../_images/prop-int-der-windup-demo.png"><img alt="../_images/prop-int-der-windup-demo.png" class="bottompadding align-center" src="../_images/prop-int-der-windup-demo.png" style="width: 90%;" />
</a>
<div class="video_wrapper align-center" style="padding-bottom: 39.375000%; padding-top: 30px; position: relative; text-align: center; width: 70%">
<iframe allowfullscreen="true" src="https://www.youtube.com/embed/cQTZo7PCRfQ" style="border: 0; height: 100%; left: 0; position: absolute; top: 0; width: 100%">
</iframe></div><p>We can see that the non-clamped term builds up (“winds up”), which
may lead to overshoot. However, since our actual term is clamped,
no such buildup occurs when at max control, and we don’t encounter
a large overshoot.</p>
</section>
<section id="acknowledgements">
<h2>Acknowledgements<a class="headerlink" href="#acknowledgements" title="Link to this heading"></a></h2>
<p>This lab was one of the hardest so far for me, but also one of the most
educational. I hadn’t encountered PID controllers before, and struggled
learning how best to tune them and what different behaviours meant.
After going through the lab, I feel much more confident in PID controllers,
and appreciate how relatively few lines of code can capture complex
behaviours. I’d like to credit the TAs a lot to my success, for staring
at my plots with me and figuring out the best next steps.</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="../lab4/" class="btn btn-neutral float-left" title="Lab 4: Open-Loop Motor Control" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../lab6/" class="btn btn-neutral float-right" title="Lab 6: Orientation Control" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Aidan McNay.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>